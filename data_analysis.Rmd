---
title: "AIMG Survey Data Analysis"
output: html_notebook
---

# Load packages, clear environment, set seed, and turn scientific notation off
```{r setup, message=FALSE, warning=FALSE}
rm(list = ls())
options(contrasts = c("contr.sum","contr.poly"), scipen = 12)
set.seed(42)

if (!require("pacman")) install.packages("pacman"); 
library(pacman)
pacman::p_load(tidyverse, dplyr,car, Hmisc, psych, TOSTER, lavaan, forcats, MuMIn, likert, QuantPsyc, lavaanPlot, semPlot, ggpubr, DescTools, lm.beta, rcompanion, cowplot, PupillometryR, viridis, patchwork)
```

# Import raw data
Note: Must export detailed response info csv + incomplete responses
```{r message=FALSE, warning=FALSE}
raw_data <- read_csv("Raw_Data/raw_data.csv")
```

# Data cleaning

## Remove test responses before 19 November
```{r}
raw_data <- raw_data %>% filter(Started > "11/19/2020 12:00:00")
```

## remove incomplete responses 
(using the `Ended` variable to determine if the survey was submitted)
```{r}
raw_data %>% tally() #initial number of responses:
raw_data <- raw_data %>% filter(!is.na(Ended)) 
raw_data %>% tally() #number of responses after removing incomplete:
```

## Remove responses for which consent was not provided
```{r}
raw_data %>% tally() #initial number of responses:
raw_data <- raw_data %>% filter(consent_consent_1_Column2 == "yes" & consent_consent_2_Column2 == "yes") 
raw_data %>% tally() #number of responses after removing incomplete
```

## Demographic variable recoding and descriptive statistics

Produce age variable from birth year
```{r}
raw_data <- raw_data %>% 
  mutate(age = as.numeric(2020 - as.numeric(birth_year))) %>% dplyr::select(-birth_year)

raw_data %>% summarise(m = mean(age), sd = sd(age))
```

Clean study year variable
```{r}
raw_data<- raw_data %>% 
  mutate(study_year = as.factor(case_when(year_study == "First Year" ~ "First Year",
                                year_study == "Second Year" ~ "Second Year",
                                year_study == "Third Year" ~ "Third Year",
                                year_study == "Fourth Year" ~ "Fourth Year",
                                TRUE ~ "Other"))) %>% dplyr::select(-year_study)

raw_data %>% 
  group_by(study_year) %>% 
  summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

Gender descriptive statistics
```{r}
raw_data <- raw_data %>% 
  mutate(gender = as.factor(case_when(gender == "female" ~"female",
                                      gender == "male" ~ "male",
                                      TRUE ~ "other")))
raw_data %>% 
  group_by(gender) %>% 
  summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

Faculty descriptive statistics 
```{r}
raw_data<- raw_data %>% 
  mutate(faculty = as.factor(faculty))

raw_data %>% 
  group_by(faculty) %>% 
  summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

Remove extraneous columns now that checks are complete
```{r}
raw_data <- raw_data %>% dplyr::select(-c(ResponseID, ResponseGuid, Started, Ended, TotalTime, LastEdit, 
                                   IP, Language, UniqueIdentifier, Invitee, Score, 
                                   consent_consent_1_Column2, consent_consent_2_Column2))
```

## Create and test scales for dependent variables

### Academic stress scale

https://doi.org/10.1375/ajgc.19.1.56 

Responses are coded: 1 - 5, no reverse coding, 21 items
"Items are summed for subscale scores and subscales are summed for a total LASRS stress response score."
"Higher scores indicate a greater stress response."

(columns written out rather than looping in case column numbers change)
```{r}
raw_data <-raw_data %>% 
  mutate(academic_stress_scale = academic_stress_academic_stress_1_Column2 + academic_stress_academic_stress_2_Column2 + 
                                    academic_stress_academic_stress_3_Column2 + academic_stress_academic_stress_4_Column2 + 
                                    academic_stress_academic_stress_5_Column2 + academic_stress_academic_stress_6_Column2 + 
                                    academic_stress_academic_stress_7_Column2 + academic_stress_academic_stress_8_Column2 + 
                                    academic_stress_academic_stress_9_Column2 + academic_stress_academic_stress_10_Column2 + 
                                    academic_stress_academic_stress_11_Column2 + academic_stress_academic_stress_12_Column2 + 
                                    academic_stress_academic_stress_13_Column2 + academic_stress_academic_stress_14_Column2 + 
                                    academic_stress_academic_stress_15_Column2 + academic_stress_academic_stress_16_Column2 + 
                                    academic_stress_academic_stress_17_Column2 + academic_stress_academic_stress_18_Column2 + 
                                    academic_stress_academic_stress_19_Column2 + academic_stress_academic_stress_20_Column2 + 
                                    academic_stress_academic_stress_21_Column2) 
```

Cronbach's alpha for internal consistency (can consider doing CFI to check factor structure correspondence with original)
```{r}
raw_data %>% 
  dplyr::select(academic_stress_academic_stress_1_Column2, academic_stress_academic_stress_2_Column2, 
         academic_stress_academic_stress_3_Column2, academic_stress_academic_stress_4_Column2, 
         academic_stress_academic_stress_5_Column2, academic_stress_academic_stress_6_Column2, 
         academic_stress_academic_stress_7_Column2, academic_stress_academic_stress_8_Column2, 
         academic_stress_academic_stress_9_Column2, academic_stress_academic_stress_10_Column2, 
         academic_stress_academic_stress_11_Column2, academic_stress_academic_stress_12_Column2, 
         academic_stress_academic_stress_13_Column2, academic_stress_academic_stress_14_Column2, 
         academic_stress_academic_stress_15_Column2, academic_stress_academic_stress_16_Column2, 
         academic_stress_academic_stress_17_Column2, academic_stress_academic_stress_18_Column2,
         academic_stress_academic_stress_19_Column2, academic_stress_academic_stress_20_Column2,  
         academic_stress_academic_stress_21_Column2) %>% 
  alpha()
```

Produce academic stress subscales
```{r}
raw_data <- raw_data %>% 
  mutate(AS_affective = academic_stress_academic_stress_20_Column2 + 
           academic_stress_academic_stress_19_Column2 + 
           academic_stress_academic_stress_6_Column2 +
           academic_stress_academic_stress_12_Column2,
         AS_behavioural = academic_stress_academic_stress_3_Column2 +
           academic_stress_academic_stress_11_Column2 +
           academic_stress_academic_stress_17_Column2 +
           academic_stress_academic_stress_16_Column2 +
           academic_stress_academic_stress_1_Column2 +
           academic_stress_academic_stress_8_Column2 +
           academic_stress_academic_stress_2_Column2 +
           academic_stress_academic_stress_7_Column2,
         AS_physiological = academic_stress_academic_stress_9_Column2 +
           academic_stress_academic_stress_21_Column2 +
           academic_stress_academic_stress_14_Column2 +
           academic_stress_academic_stress_15_Column2 +
           academic_stress_academic_stress_10_Column2,
         AS_Cognitive = academic_stress_academic_stress_18_Column2 +
           academic_stress_academic_stress_4_Column2 +
           academic_stress_academic_stress_13_Column2 +
           academic_stress_academic_stress_5_Column2)
```

Remove unnecessary columns
```{r}
raw_data <- raw_data %>% dplyr::select(-c(academic_stress_academic_stress_1_Column2, academic_stress_academic_stress_2_Column2, 
         academic_stress_academic_stress_3_Column2, academic_stress_academic_stress_4_Column2, 
         academic_stress_academic_stress_5_Column2, academic_stress_academic_stress_6_Column2, 
         academic_stress_academic_stress_7_Column2, academic_stress_academic_stress_8_Column2, 
         academic_stress_academic_stress_9_Column2, academic_stress_academic_stress_10_Column2, 
         academic_stress_academic_stress_11_Column2, academic_stress_academic_stress_12_Column2, 
         academic_stress_academic_stress_13_Column2, academic_stress_academic_stress_14_Column2, 
         academic_stress_academic_stress_15_Column2, academic_stress_academic_stress_16_Column2, 
         academic_stress_academic_stress_17_Column2, academic_stress_academic_stress_18_Column2,
         academic_stress_academic_stress_19_Column2, academic_stress_academic_stress_20_Column2,  
         academic_stress_academic_stress_21_Column2))
```

### Learning Community Scale
Responses are coded: 1 - 5, no reverse coding, and aggregated
```{r}
raw_data <- raw_data %>% 
  mutate(LCS = (EQ_LCS_1_Column2+EQ_LCS_2_Column2+EQ_LCS_3_Column2+EQ_LCS_4_Column2+EQ_LCS_5_Column2)/5)
```

Cronbach's alpha
```{r}
raw_data %>% dplyr::select(EQ_LCS_1_Column2, EQ_LCS_2_Column2, 
                    EQ_LCS_3_Column2, EQ_LCS_4_Column2, 
                    EQ_LCS_5_Column2) %>% alpha()
```

### Good Teaching Scale 
Responses are coded: 1 - 5, no reverse coding, and aggregated
```{r}
raw_data <- raw_data %>% 
  mutate(GTS = (EQ_GTS_1_Column2+EQ_GTS_2_Column2+EQ_GTS_3_Column2+EQ_GTS_4_Column2+EQ_GTS_5_Column2)/5)
```

```{r}
raw_data %>% dplyr::select(EQ_GTS_1_Column2, EQ_GTS_2_Column2, 
                    EQ_GTS_3_Column2, EQ_GTS_4_Column2, 
                    EQ_GTS_5_Column2) %>% alpha()
```

### Overall Satisfaction Index
```{r}
raw_data <- raw_data %>% 
  mutate(OSI = as.factor(EQ_OSI_Column2)) %>% 
  mutate(OSI = fct_relevel(OSI, c("1","2","3","4","5")))
```

Remove unnecessary columns
```{r}
raw_data <- raw_data %>% dplyr::select(-c(EQ_LCS_1_Column2, EQ_LCS_2_Column2, 
                    EQ_LCS_3_Column2, EQ_LCS_4_Column2, 
                    EQ_LCS_5_Column2, EQ_GTS_1_Column2, EQ_GTS_2_Column2, 
                    EQ_GTS_3_Column2, EQ_GTS_4_Column2, 
                    EQ_GTS_5_Column2, EQ_OSI_Column2))
```

## Descriptive statistics for Dependent variables

Note, OSI variable is categorical (ordinal) not numeric (indicated with an asterisk)
```{r}
raw_data %>% 
  dplyr::select(academic_performance, 
                    academic_stress_scale, AS_affective, AS_behavioural, AS_physiological, AS_Cognitive,
                    LCS, GTS, OSI) %>% 
  psych::describe()
```

## Produce AIMGs Usage scales

### Produce proportion values

First set the module proportion to factor and create new variables

```{r}
raw_data<-raw_data %>% 
  mutate(use_proportion_formal_AIMG = as.factor(Group_Use_formal_AIMG_extent_Column2),
         use_proportion_class_AIMG = as.factor(Group_Use_class_AIMG_extent_Column2),
         use_proportion_study_AIMG = as.factor(Group_Use_group_AIMG_extent_Column2)) %>% 
  dplyr::select(-c(Group_Use_formal_AIMG_extent_Column2,Group_Use_class_AIMG_extent_Column2,Group_Use_group_AIMG_extent_Column2))
```

```{r}
use_proportion <- raw_data %>% dplyr::select(use_proportion_formal_AIMG, use_proportion_class_AIMG, use_proportion_study_AIMG)

use_proportion_data <- pivot_longer(data = use_proportion, cols = c(use_proportion_formal_AIMG, use_proportion_class_AIMG, use_proportion_study_AIMG), names_to = "group_type", values_to = "response")
```

```{r}
use_proportion_figure<- use_proportion_data %>% 
  mutate(response = factor(response)) %>% 
  mutate(response = fct_relevel(response, 
                                "In all of my modules", "In more than half of my modules", "In about half of my modules", "In less than half of my modules", "In none of my modules")) %>% 
  mutate(group_type = factor(case_when(group_type == "use_proportion_formal_AIMG" ~"Formal AIMGs",
                                group_type == "use_proportion_class_AIMG" ~"Class AIMGs",
                                group_type == "use_proportion_study_AIMG" ~"Study AIMGs"), levels = c("Study AIMGs", "Class AIMGs", "Formal AIMGs"))) %>% 
  group_by(group_type, response) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = group_type, fill = response, y = count))+
  geom_bar(position = "fill", stat = "identity") + 
  scale_fill_brewer(palette = "Blues", direction = -1)+
  labs(title = "Proportion of modules in which three types of AIMG are used", fill = "Response", y = "Proportion of respondents", x = "Group Type")+
  coord_flip() + 
  theme_minimal() +   
  theme(axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 10))

use_proportion_figure

ggsave((filename="Figures/use_proportion_figure.pdf"), scale = 1, width = 10, height=5, dpi = 600, limitsize = TRUE, use_proportion_figure)
```

Recode to numeric from raw responses
```{r}
raw_data <- raw_data %>% 
  mutate(use_proportion_formal_AIMG  = case_when(use_proportion_formal_AIMG == "In none of my modules" ~0,
                                              use_proportion_formal_AIMG == "In less than half of my modules" ~1,
                                              use_proportion_formal_AIMG == "In about half of my modules" ~2,
                                              use_proportion_formal_AIMG == "In more than half of my modules" ~3,
                                              use_proportion_formal_AIMG == "In all of my modules" ~4)) %>% 
  mutate(use_proportion_class_AIMG  = case_when(use_proportion_class_AIMG == "In none of my modules" ~0,
                                              use_proportion_class_AIMG == "In less than half of my modules" ~1,
                                              use_proportion_class_AIMG == "In about half of my modules" ~2,
                                              use_proportion_class_AIMG == "In more than half of my modules" ~3,
                                              use_proportion_class_AIMG == "In all of my modules" ~4)) %>% 
  mutate(use_proportion_study_AIMG  = case_when(use_proportion_study_AIMG == "In none of my modules" ~0,
                                              use_proportion_study_AIMG == "In less than half of my modules" ~1,
                                              use_proportion_study_AIMG == "In about half of my modules" ~2,
                                              use_proportion_study_AIMG == "In more than half of my modules" ~3,
                                              use_proportion_study_AIMG == "In all of my modules" ~4))
```

```{r}
raw_data %>% dplyr::select(use_proportion_formal_AIMG, use_proportion_class_AIMG, use_proportion_study_AIMG) %>% 
  psych::describe()
```

```{r}
raw_data %>% dplyr::select(use_proportion_formal_AIMG) %>%
  group_by(use_proportion_formal_AIMG) %>% 
    summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

```{r}
raw_data %>% dplyr::select(use_proportion_class_AIMG) %>%
  group_by(use_proportion_class_AIMG) %>% 
    summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

```{r}
raw_data %>% dplyr::select(use_proportion_study_AIMG) %>%
  group_by(use_proportion_study_AIMG) %>% 
    summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

#Q: Is their a clear pattern in who indicates that they use Formal AIMGs in all of their modules? 
#A: No
```{r}
raw_data %>% 
  filter(use_proportion_formal_AIMG == 4) %>% 
  dplyr::select(faculty) %>%  
  group_by(faculty) %>% 
  summarise(n=n()) %>% 
  mutate(perc = n/sum(n)*100)
```

#Visualise frequencies
```{r}
raw_data<- raw_data %>% 
  mutate(class_read_frequency = `_class_AIMG_read_Column2`,
         class_post_frequency = `_class_AIMG_post_Column2`,
         class_share_frequency = `_class_AIMG_share_Column2`,
         formal_read_frequency = `_formal_AIMG_read_Column2`,
         formal_post_frequency = `_formal_AIMG_post_Column2`,
         formal_share_frequency = `_formal_AIMG_share_Column2`,
         study_read_frequency = `_group_AIMG_read_Column2`,
         study_post_frequency = `_group_AIMG_post_Column2`,
         study_share_frequency = `_group_AIMG_share_Column2`)
```

```{r}
use_frequency_figure <- raw_data %>% dplyr::select(study_read_frequency, formal_read_frequency, class_read_frequency,
                           study_post_frequency,formal_post_frequency, class_post_frequency,
                           study_share_frequency, formal_share_frequency, class_share_frequency) %>% 
    pivot_longer(cols = c(study_read_frequency, formal_read_frequency, class_read_frequency,
                           study_post_frequency,formal_post_frequency, class_post_frequency,
                           study_share_frequency, formal_share_frequency, class_share_frequency), 
                 names_to = "context", values_to = "frequency") %>% 
  separate(context, into = c("group_type", "action_type", "other"), sep = "_") %>% 
  dplyr::select(group_type, action_type, frequency) %>% 
  mutate(frequency = factor(case_when(frequency == "never" ~ "Never",
                                      frequency == "a couple of times per semester" ~ "A couple of times per semester",
                                      frequency == "a couple of times per week" ~ "A couple of times per week",
                                      frequency == "daily" ~ "Daily", 
                                      frequency == "multiple times per day" ~ "Multiple times per day"), 
                            levels = c("Multiple times per day", "Daily","A couple of times per week","A couple of times per semester" ,"Never")),
         group_type = factor(case_when(group_type == "formal"~ "Formal AIMGs",
                                group_type == "class"~ "Class AIMGs",
                                group_type == "study" ~ "Study AIMGs"), 
                             levels = c("Study AIMGs", "Class AIMGs", "Formal AIMGs")),
         action_type = factor(case_when(action_type == "read"~ "Read",
                                action_type == "post"~ "Post",
                                action_type == "share" ~ "Share"), 
                             levels = c("Read", "Post", "Share"))) %>% 
  group_by(group_type, action_type, frequency) %>% 
  filter(!is.na(frequency)) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(fill=factor(frequency), y=count, x=group_type)) + 
    geom_bar(position="dodge", stat="identity") +
  scale_fill_brewer(palette = "Blues")+
  labs(fill = "Frequency", x = "AIMG Type", y = "Count", title="Participation frequency by action type and group type")+
  scale_y_continuous(expand = expansion(mult = c(0, .1)))+
  theme_minimal() + coord_flip()+
  theme(axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom") + guides(fill=guide_legend(nrow=2,byrow=TRUE, reverse = TRUE)) +
  facet_wrap(~action_type)

use_frequency_figure

ggsave((filename="Figures/use_frequency_figure.pdf"), scale = 1, width = 10, height=5, dpi = 600, limitsize = TRUE, use_frequency_figure)
```
```{r}
raw_data %>% dplyr::select(study_read_frequency, formal_read_frequency, class_read_frequency,
                           study_post_frequency,formal_post_frequency, class_post_frequency,
                           study_share_frequency, formal_share_frequency, class_share_frequency) %>% 
    pivot_longer(cols = c(study_read_frequency, formal_read_frequency, class_read_frequency,
                           study_post_frequency,formal_post_frequency, class_post_frequency,
                           study_share_frequency, formal_share_frequency, class_share_frequency), names_to = "context", values_to = "frequency") %>% 
  separate(context, into = c("group_type", "action_type", "other"), sep = "_") %>% 
  dplyr::select(group_type, action_type, frequency) %>% 
  group_by(group_type, action_type, frequency) %>% 
  filter(!is.na(frequency)) %>% 
  summarise(count = n())  %>% 
  mutate(perc = count/sum(count)*100) %>% 
  arrange(group_type) #note, arrange ignores groups
```


### Produce frequency scales

#### Class groups frequency (recode and combine)

Note: never = 0; a couple of times per semester = 0.25; a couple of times per week = 0.5; daily = 1; multiple times per day = 2; NA = 0 (because default to NA if not selected)

```{r}
raw_data<- raw_data %>% 
  mutate(class_read_frequency = case_when(`_class_AIMG_read_Column2` == "never" ~ 0,
                                          `_class_AIMG_read_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_class_AIMG_read_Column2` == "a couple of times per week" ~ 0.5,
                                          `_class_AIMG_read_Column2` == "daily" ~ 1,
                                          `_class_AIMG_read_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_class_AIMG_read_Column2`) ~ 0)) %>% 
  mutate(class_post_frequency = case_when(`_class_AIMG_post_Column2` == "never" ~ 0,
                                          `_class_AIMG_post_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_class_AIMG_post_Column2` == "a couple of times per week" ~ 0.5,
                                          `_class_AIMG_post_Column2` == "daily" ~ 1,
                                          `_class_AIMG_post_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_class_AIMG_post_Column2`) ~ 0)) %>% 
  mutate(class_share_frequency = case_when(`_class_AIMG_share_Column2` == "never" ~ 0,
                                          `_class_AIMG_share_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_class_AIMG_share_Column2` == "a couple of times per week" ~ 0.5,
                                          `_class_AIMG_share_Column2` == "daily" ~ 1,
                                          `_class_AIMG_share_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_class_AIMG_share_Column2`) ~ 0))  %>% 
  dplyr::select(-c(`_class_AIMG_read_Column2`, `_class_AIMG_post_Column2`, `_class_AIMG_share_Column2`))
```

Produce combined frequency variable
```{r}
raw_data<- raw_data %>% 
  mutate(frequency_class = as.numeric(class_read_frequency+class_post_frequency+class_share_frequency))
```

#### Formal group frequency (recode and combine)

```{r}
raw_data<- raw_data %>% 
  mutate(formal_read_frequency = case_when(`_formal_AIMG_read_Column2` == "never" ~ 0,
                                          `_formal_AIMG_read_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_formal_AIMG_read_Column2` == "a couple of times per week" ~ 0.5,
                                          `_formal_AIMG_read_Column2` == "daily" ~ 1,
                                          `_formal_AIMG_read_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_formal_AIMG_read_Column2`) ~ 0)) %>% 
  mutate(formal_post_frequency = case_when(`_formal_AIMG_post_Column2` == "never" ~ 0,
                                          `_formal_AIMG_post_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_formal_AIMG_post_Column2` == "a couple of times per week" ~ 0.5,
                                          `_formal_AIMG_post_Column2` == "daily" ~ 1,
                                          `_formal_AIMG_post_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_formal_AIMG_post_Column2`) ~ 0)) %>% 
  mutate(formal_share_frequency = case_when(`_formal_AIMG_share_Column2` == "never" ~ 0,
                                          `_formal_AIMG_share_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_formal_AIMG_share_Column2` == "a couple of times per week" ~ 0.5,
                                          `_formal_AIMG_share_Column2` == "daily" ~ 1,
                                          `_formal_AIMG_share_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_formal_AIMG_share_Column2`) ~ 0))  %>% 
  dplyr::select(-c(`_formal_AIMG_read_Column2`, `_formal_AIMG_post_Column2`, `_formal_AIMG_share_Column2`))
```

Produce combined frequency variable
```{r}
raw_data<- raw_data %>% 
  mutate(frequency_formal = as.numeric(formal_read_frequency+formal_post_frequency+formal_share_frequency))
```

#### Study-group frequency (recode and combine)

```{r}
raw_data<- raw_data %>% 
  mutate(study_read_frequency = case_when(`_group_AIMG_read_Column2` == "never" ~ 0,
                                          `_group_AIMG_read_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_group_AIMG_read_Column2` == "a couple of times per week" ~ 0.5,
                                          `_group_AIMG_read_Column2` == "daily" ~ 1,
                                          `_group_AIMG_read_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_group_AIMG_read_Column2`) ~ 0)) %>% 
  mutate(study_post_frequency = case_when(`_group_AIMG_post_Column2` == "never" ~ 0,
                                          `_group_AIMG_post_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_group_AIMG_post_Column2` == "a couple of times per week" ~ 0.5,
                                          `_group_AIMG_post_Column2` == "daily" ~ 1,
                                          `_group_AIMG_post_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_group_AIMG_post_Column2`) ~ 0)) %>% 
  mutate(study_share_frequency = case_when(`_group_AIMG_share_Column2` == "never" ~ 0,
                                          `_group_AIMG_share_Column2` == "a couple of times per semester" ~ 0.25,
                                          `_group_AIMG_share_Column2` == "a couple of times per week" ~ 0.5,
                                          `_group_AIMG_share_Column2` == "daily" ~ 1,
                                          `_group_AIMG_share_Column2` == "multiple times per day" ~ 2,
                                          is.na(`_group_AIMG_share_Column2`) ~ 0))  %>% 
  dplyr::select(-c(`_group_AIMG_read_Column2`, `_group_AIMG_post_Column2`, `_group_AIMG_share_Column2`))
```

Produce combined frequency variable
```{r}
raw_data<- raw_data %>% 
  mutate(frequency_study = as.numeric(study_read_frequency+study_post_frequency+study_share_frequency))
```


### Combine to produce overall participation scales

```{r}
raw_data <- raw_data %>% 
  mutate(class_overall_participation = as.numeric(frequency_class * use_proportion_class_AIMG),
         formal_overall_participation = as.numeric(frequency_formal * use_proportion_formal_AIMG),
         study_overall_participation = as.numeric(frequency_study * use_proportion_study_AIMG))
```

```{r}
raw_data %>% 
  dplyr::select(class_overall_participation, 
                    formal_overall_participation, study_overall_participation) %>% 
  psych::describe()
```
# Visualise overall participation

```{r}
raw_data %>% 
  dplyr::select(class_overall_participation, formal_overall_participation, study_overall_participation) %>% 
  pivot_longer(cols = c(class_overall_participation, formal_overall_participation, study_overall_participation), names_to = "group_type", values_to = "overall_participation") %>% 
  mutate(group_type = factor(case_when(group_type == "study_overall_participation"~ "Study AIMGs",
                                group_type == "formal_overall_participation" ~ "Formal AIMGs",
                                group_type == "class_overall_participation" ~ "Class AIMGs"), levels = c("Study AIMGs", "Class AIMGs", "Formal AIMGs"))) %>% 
  ggplot(aes(y = overall_participation, x = group_type, fill=group_type)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = overall_participation, color = group_type), position = position_jitter(width = .15), size = .5, alpha = 0.8) + 
  geom_boxplot(width = .1, guides = FALSE, outlier.shape = NA, alpha = 0.5) +
expand_limits(x = 3) + 
  guides(fill = FALSE) +
  labs(x = "Group Type", y = "Level of participation", title = "Participation in the three types of AIMGs")+
  guides(color=FALSE)+
  coord_flip() +
theme_bw() 


#ggsave((filename="figures/usage_raincloud_plot.pdf"), scale = 1, width = 10, height=5, dpi = 600, limitsize = TRUE, raincloud_plot)
```



Make raincloud for 3 groups for overall

Visualise for purposes and motivations

3 bars per item, 2 
stacked bar graph
Q1 formal, class, study
Q2 formal, class, study


# Use purposes and motivations

### This can be done seperately and returned to later (leaving for now to move on with main analysis planning...)

(can be done in the main dataframe just doing separately for now...)
(This still needs tweaking to deal with NAs etc. but the rough idea works)

## Create seperate datasets for the use purposes and motivations variables

```{r}
formal_uses_data <- raw_data %>% dplyr::select(starts_with("These groups are used")) %>% dplyr::select(contains("formal"))
class_uses_data <- raw_data %>% dplyr::select(starts_with("These groups are used")) %>% dplyr::select(contains("class"))
group_uses_data <- raw_data %>% dplyr::select(starts_with("These groups are used")) %>% dplyr::select(contains("to_group"))

formal_uses_data <- formal_uses_data %>% 
  add_column(group_type = "formal")

class_uses_data <- class_uses_data %>% 
  add_column(group_type = "class")

group_uses_data <- group_uses_data %>% 
  add_column(group_type = "group")

formal_uses_data <- formal_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_formal_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_formal_discuss_content_Column2`,
         share_notes = `These groups are used to_formal_share_notes_Column2`,
         share_answers = `These groups are used to_formal_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_formal_coordinate_group_Column2`,
         encourage = `These groups are used to_formal_encourage_Column2`,
         share_non_academic = `These groups are used to_formal_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_formal_communicate_administrative_Column2`, `These groups are used to_formal_discuss_content_Column2`,
            `These groups are used to_formal_share_notes_Column2`, `These groups are used to_formal_share_answers_Column2`,
            `These groups are used to_formal_coordinate_group_Column2`, `These groups are used to_formal_encourage_Column2`,
            `These groups are used to_formal_share_non_academic_Column2`))

class_uses_data <- class_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_class_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_class_discuss_academic_Column2`,
         share_notes = `These groups are used to_class_share_notes_Column2`,
         share_answers = `These groups are used to_class_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_class_coordinate_group_Column2`,
         encourage = `These groups are used to_class_encourage_Column2`,
         share_non_academic = `These groups are used to_class_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_class_communicate_administrative_Column2`, `These groups are used to_class_discuss_academic_Column2`,
            `These groups are used to_class_share_notes_Column2`, `These groups are used to_class_share_answers_Column2`,
            `These groups are used to_class_coordinate_group_Column2`, `These groups are used to_class_encourage_Column2`,
            `These groups are used to_class_share_non_academic_Column2`))

group_uses_data <- group_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_group_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_group_discuss_academic_Column2`,
         share_notes = `These groups are used to_group_share_notes_Column2`,
         share_answers = `These groups are used to_group_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_group_coordinate_group_Column2`,
         encourage = `These groups are used to_group_encourage_Column2`,
         share_non_academic = `These groups are used to_group_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_group_communicate_administrative_Column2`, `These groups are used to_group_discuss_academic_Column2`,
            `These groups are used to_group_share_notes_Column2`, `These groups are used to_group_share_answers_Column2`,
            `These groups are used to_group_coordinate_group_Column2`, `These groups are used to_group_encourage_Column2`,
            `These groups are used to_group_share_non_academic_Column2`))

raw_data_purposes <- rbind(formal_uses_data, class_uses_data, group_uses_data) 
```
```{r}
levels = c("always", "mostly", "about half the time", "rarely", "never")

use_purposes_fig <- raw_data_purposes %>% filter(!is.na(communicate_administrative))  %>% 
  mutate(communicate_administrative = factor(communicate_administrative, levels, ordered=TRUE),
         discuss_content = factor(discuss_content, levels, ordered=TRUE),
         share_notes = factor(share_notes, levels, ordered=TRUE),
         share_answers = factor(share_answers, levels, ordered=TRUE),
         coordinate_groupwork = factor(coordinate_groupwork, levels, ordered=TRUE),
         encourage = factor(encourage, levels, ordered=TRUE),
         share_non_academic = factor(share_non_academic, levels, ordered=TRUE),
         group_type = case_when(group_type == "formal"~"Formal AIMGs",
                                group_type =="class"~"Class AIMGs",
                                group_type == "group" ~ "Study AIMGs")) %>% pivot_longer(cols = c(communicate_administrative, discuss_content,
                                            share_notes, share_answers, coordinate_groupwork, encourage, share_non_academic), names_to = "Use_purpose", values_to = "response") %>% 
 group_by(group_type, Use_purpose, response)  %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(group_type, Use_purpose) %>% 
  mutate(count_resp = sum(n)) %>% 
  group_by(Use_purpose, add = TRUE) %>% 
  mutate(per = round(100*n/count_resp,2)) %>% 
  ggplot(aes(x = Use_purpose, y = per, fill = response)) +
  geom_bar(stat = "identity", width = 0.8) + coord_flip() + facet_wrap(~group_type, ncol=1) + 
  #geom_text(aes(label=per), position = position_stack(.5), size = 3)+
  scale_fill_brewer(palette = "RdYlGn", direction = -1)+
  labs(x = "Use purpose", y = "Response proportion")+
  theme_minimal() + 
  coord_flip()+
  theme(axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom") + guides(fill=guide_legend(nrow=1,byrow=TRUE, reverse = TRUE)) 
use_purposes_fig
ggsave((filename="Figures/use_purposes_figure.pdf"), scale = 1, width = 10, height=5, dpi = 600, limitsize = TRUE, use_purposes_fig)
```

# Use outcomes

```{r}
formal_outcomes_data <- raw_data %>% dplyr::select(starts_with("Please indicate your level of agreement with the following statements")) %>% dplyr::select(contains("formal"))
class_outcomes_data <- raw_data %>% dplyr::select(starts_with("Please indicate your level of agreement with the following statements")) %>% dplyr::select(contains("class"))
group_outcomes_data <- raw_data %>% dplyr::select(starts_with("Please indicate your level of agreement with the following statements")) %>% dplyr::select(contains("group_outcome"))

formal_outcomes_data <- formal_outcomes_data %>% 
  add_column(group_type = "formal")

class_outcomes_data <- class_outcomes_data %>% 
  add_column(group_type = "class")

group_outcomes_data <- group_outcomes_data %>% 
  add_column(group_type = "group")


formal_uses_data <- formal_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_formal_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_formal_discuss_content_Column2`,
         share_notes = `These groups are used to_formal_share_notes_Column2`,
         share_answers = `These groups are used to_formal_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_formal_coordinate_group_Column2`,
         encourage = `These groups are used to_formal_encourage_Column2`,
         share_non_academic = `These groups are used to_formal_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_formal_communicate_administrative_Column2`, `These groups are used to_formal_discuss_content_Column2`,
            `These groups are used to_formal_share_notes_Column2`, `These groups are used to_formal_share_answers_Column2`,
            `These groups are used to_formal_coordinate_group_Column2`, `These groups are used to_formal_encourage_Column2`,
            `These groups are used to_formal_share_non_academic_Column2`))

class_uses_data <- class_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_class_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_class_discuss_academic_Column2`,
         share_notes = `These groups are used to_class_share_notes_Column2`,
         share_answers = `These groups are used to_class_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_class_coordinate_group_Column2`,
         encourage = `These groups are used to_class_encourage_Column2`,
         share_non_academic = `These groups are used to_class_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_class_communicate_administrative_Column2`, `These groups are used to_class_discuss_academic_Column2`,
            `These groups are used to_class_share_notes_Column2`, `These groups are used to_class_share_answers_Column2`,
            `These groups are used to_class_coordinate_group_Column2`, `These groups are used to_class_encourage_Column2`,
            `These groups are used to_class_share_non_academic_Column2`))

group_uses_data <- group_uses_data %>% 
  mutate(communicate_administrative = `These groups are used to_group_communicate_administrative_Column2`,
         discuss_content = `These groups are used to_group_discuss_academic_Column2`,
         share_notes = `These groups are used to_group_share_notes_Column2`,
         share_answers = `These groups are used to_group_share_answers_Column2`,
         coordinate_groupwork = `These groups are used to_group_coordinate_group_Column2`,
         encourage = `These groups are used to_group_encourage_Column2`,
         share_non_academic = `These groups are used to_group_share_non_academic_Column2`) %>% 
  dplyr::select(-c(`These groups are used to_group_communicate_administrative_Column2`, `These groups are used to_group_discuss_academic_Column2`,
            `These groups are used to_group_share_notes_Column2`, `These groups are used to_group_share_answers_Column2`,
            `These groups are used to_group_coordinate_group_Column2`, `These groups are used to_group_encourage_Column2`,
            `These groups are used to_group_share_non_academic_Column2`))

raw_data_purposes <- rbind(formal_uses_data, class_uses_data, group_uses_data) 
```









## correlation matrix
```{r}
raw_data %>% 
  dplyr::select(frequency_class, frequency_formal, frequency_study, 
         use_proportion_class_AIMG, use_proportion_formal_AIMG, use_proportion_study_AIMG,
         class_overall_participation, formal_overall_participation, study_overall_participation,
         academic_performance, academic_stress_scale, GTS, LCS, OSI) %>% 
  as.matrix() %>% 
  rcorr(type = "spearman") #should all be spearman or only those with the OSI item and the rest Pearson??
```

## Modeling

### Regression analysis with control variables

Multiple regression models will be produced to determine the predictive capacity of the AIMG participation variables over academic performance, academic stress and subjects’ perceptions of education quality and (operationalised through the good-teaching scale, learning community scale, and overall satisfaction index)indiinvolvement.

Controlling for gender, faculty, and study-year. [report controlled for but not in table]

predicting AP
```{r}
AP_model <- lm(academic_performance ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_stress_scale + LCS+GTS + age + faculty + study_year + gender, data = raw_data)
summary(AP_model)

AP_model_standardised_ceofs <- lm.beta(AP_model) 
AP_model_standardised_ceofs
```

Predicting AS
```{r}
AS_model <- lm(academic_stress_scale ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + LCS+GTS+ age + faculty + study_year + gender, data = raw_data)
summary(AS_model)

#standardise coefficients
AS_model_standardised_ceofs <- lm.beta(AS_model)
AS_model_standardised_ceofs
```

Predicting LCS
```{r}
LCS_model <- lm(LCS ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + academic_stress_scale+GTS+ age + faculty + study_year + gender, data = raw_data)
summary(LCS_model)

#standardise coefficients
LCS_model_standardised_ceofs <- lm.beta(LCS_model)
LCS_model_standardised_ceofs
```

Predicting GTS
```{r}
GTS_model <- lm(GTS ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + academic_stress_scale+LCS+ age + faculty + study_year + gender, data = raw_data)
summary(GTS_model)

#standardise coefficients
GTS_model_standardised_ceofs <- lm.beta(GTS_model)
GTS_model_standardised_ceofs
```

Predicting OSI: ordinal logistic regression

Below we use the polr command from the MASS package to estimate an ordered logistic regression model. (proportional odds logistic regression)

See below for interpretation of coefficients
```{r}
OSI_model <- polr(OSI ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + academic_stress_scale+LCS +GTS + age + faculty + study_year + gender, data = raw_data, Hess=TRUE)
summary(OSI_model)
```

To get p-values for coefficients
```{r}
ctable <- coef(summary(OSI_model))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
exp_coef <- exp(ctable[, "Value"])
(ctable <- cbind(ctable, "p value" = p, "exp_coef" = exp_coef))
#confint.default(OSI_model) #check...
```

The coefficients from the model can be somewhat difficult to interpret because they are scaled in terms of logs. Another way to interpret logistic regression models is to convert the coefficients into odds ratios. To get the OR and confidence intervals, we just exponentiate the estimates and confidence intervals.

These coefficients are called proportional odds ratios and we would interpret these pretty much as we would odds ratios from a binary logistic regression. (see last column above)

i.e., For every one unit increase in, for example, overall participation in class AIMGs the odds of having a higher OSI is multiplied by the exp_coef value times (i.e., increases 85%), holding constant all other variables.



# Further post hoc exploratory analyses

### SEM option

With formal groups

```{r}
model <- 'academic_performance ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_stress_scale + GTS + LCS
academic_stress_scale ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + GTS + LCS
GTS ~ class_overall_participation + formal_overall_participation + study_overall_participation + academic_performance + academic_stress_scale + LCS
LCS ~ class_overall_participation + formal_overall_participation + study_overall_participation  + academic_performance + academic_stress_scale + GTS
class_overall_participation~~formal_overall_participation
class_overall_participation~~study_overall_participation
formal_overall_participation~~study_overall_participation'
```

```{r}
fit <- sem(model, data=raw_data)
summary(fit, fit.measures = T, standardize = T)
```

```{r}
semPaths(fit, rotation=2)
```

Without formal groups

```{r}
model <- 'academic_performance ~ class_overall_participation+ study_overall_participation + academic_stress_scale + GTS + LCS
academic_stress_scale ~ class_overall_participation + study_overall_participation + academic_performance + GTS + LCS
GTS ~ class_overall_participation + study_overall_participation + academic_performance + academic_stress_scale + LCS
LCS ~ class_overall_participation + study_overall_participation  + academic_performance + academic_stress_scale + GTS
class_overall_participation~~study_overall_participation'
```

```{r}
fit <- sem(model, data=raw_data)
summary(fit, fit.measures = T, standardize = T)
```

```{r}
semPaths(fit, rotation=2,residuals=F)
```